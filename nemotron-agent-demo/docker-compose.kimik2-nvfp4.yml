services:
  autonomous-ui:
    build:
      context: ..
      dockerfile: nemotron-agent-demo/Dockerfile.ui
    container_name: autonomous-ui
    restart: unless-stopped
    environment:
      VLLM_BASE_URL: http://host.docker.internal:8000/v1
      VLLM_MODEL_ID: ${VLLM_MODEL_ID:-deepseek/DeepSeek-V3.1-NVFP4/}
      GRADIO_SERVER_NAME: 0.0.0.0
      GRADIO_SERVER_PORT: 7860
      DML_BASE_URL: http://dml-service:9001
      DOCKER_HOST: unix:///var/run/docker.sock
      PYTHONPATH: /app:/app/nemostation/vendors/daystrom_memory_lattice_alpha1
    group_add:
      - "987"
    ports:
      - "7860:7860"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./prompt_library:/app/prompt_library
      - ./context:/app/context:ro
      - ./prompts:/app/prompts:ro
      - ../vendors:/app/nemostation/vendors:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      dml-service:
        condition: service_healthy

  dml-service:
    build:
      context: ..
      dockerfile: nemotron-agent-demo/server/dml_service/Dockerfile
    container_name: dml-service
    restart: unless-stopped
    environment:
      DML_STORAGE_DIR: /data/dml
      DML_LLM_BACKEND: openai
      DML_OPENAI_BASE_URL: http://host.docker.internal:8000/v1
      DML_OPENAI_API_KEY: "null"
      DML_OPENAI_MODEL: ${VLLM_MODEL_ID:-deepseek/DeepSeek-V3.1-NVFP4/}
      DML_SUMMARY_MAX_TOKENS: 256
      DML_SUMMARY_TEMPERATURE: 0.2
      DML_SUMMARY_TOP_P: 0.95
      DML_SUMMARY_ENABLE_THINKING: "false"
      PYTHONPATH: /app:/app/nemostation/vendors/daystrom_memory_lattice_alpha1
    volumes:
      - ./data/dml:/data/dml
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9001/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  autonomous-playground-image:
    build:
      context: ..
      dockerfile: nemotron-agent-demo/playground/Dockerfile
    image: autonomous-playground:latest
    profiles:
      - playground
      - cluster
