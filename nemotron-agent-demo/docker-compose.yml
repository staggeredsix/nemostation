services:
  nemotron-trtllm:
    image: nvcr.io/nvidia/tensorrt-llm/release:1.2.0rc5
    container_name: nemotron-trtllm
    ports:
      - "8000:8000"
    gpus: all
    ipc: host
    shm_size: "8gb"
    ulimits:
      memlock: -1
      stack: 67108864
    environment:
      MODEL_ID: ${MODEL_ID:-nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16}
      HF_TOKEN: ${HF_TOKEN:-}
      TRTLLM_ENABLE_PDL: 1
    volumes:
      - ./_hf_cache:/root/.cache/huggingface
      - ./_trtllm_cache:/trtllm_cache
      - ./server/trtllm:/app/trtllm
    entrypoint: ["/bin/bash", "/app/trtllm/entrypoint.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/v1/models >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 300
      start_period: 30m

  nemotron-ui:
    build:
      context: ..
      dockerfile: nemotron-agent-demo/Dockerfile.ui
    container_name: nemotron-ui
    restart: unless-stopped
    environment:
      OPENAI_BASE_URL: http://nemotron-trtllm:8000/v1
      GRADIO_SERVER_NAME: 0.0.0.0
      GRADIO_SERVER_PORT: 7860
      DML_BASE_URL: http://dml-service:9001
      PYTHONPATH: /app:/app/nemostation/vendors/daystrom_memory_lattice_alpha1
    ports:
      - "7860:7860"
    volumes:
      - ./prompt_library:/app/prompt_library
      - ./context:/app/context:ro
      - ./prompts:/app/prompts:ro
      - ../vendors:/app/nemostation/vendors:ro
    depends_on:
      nemotron-trtllm:
        condition: service_healthy
      dml-service:
        condition: service_healthy

  dml-service:
    build:
      context: ..
      dockerfile: nemotron-agent-demo/server/dml_service/Dockerfile
    container_name: dml-service
    restart: unless-stopped
    environment:
      DML_STORAGE_DIR: /data/dml
      PYTHONPATH: /app:/app/nemostation/vendors/daystrom_memory_lattice_alpha1
    volumes:
      - ./data/dml:/data/dml
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9001/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
